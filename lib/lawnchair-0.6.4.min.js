var Lawnchair=function(d,h){if(!(this instanceof Lawnchair))return new Lawnchair(d,h);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0){h=typeof arguments[0]==="function"?arguments[0]:arguments[1];d=typeof arguments[0]==="function"?{}:arguments[0]}else throw"Incorrect # of ctor args!";if(typeof h!=="function")throw"No callback was provided";this.record=d.record||"record";this.name=d.name||"records";var a;if(d.adapter)for(var b=
0,c=Lawnchair.adapters.length;b<c;b++){if(Lawnchair.adapters[b].adapter===d.adapter){a=Lawnchair.adapters[b].valid()?Lawnchair.adapters[b]:undefined;break}}else{b=0;for(c=Lawnchair.adapters.length;b<c;b++)if(a=Lawnchair.adapters[b].valid()?Lawnchair.adapters[b]:undefined)break}if(!a)throw"No valid adapter.";for(var e in a)this[e]=a[e];b=0;for(c=Lawnchair.plugins.length;b<c;b++)Lawnchair.plugins[b].call(this);this.init(d,h)};Lawnchair.adapters=[];
Lawnchair.adapter=function(d,h){h.adapter=d;var a="adapter valid init keys save batch get exists all remove nuke".split(" "),b=this.prototype.indexOf,c;for(c in h)if(b(a,c)===-1)throw"Invalid adapter! Nonstandard method: "+c;Lawnchair.adapters.splice(0,0,h)};Lawnchair.plugins=[];Lawnchair.plugin=function(d){for(var h in d)h==="init"?Lawnchair.plugins.push(d[h]):this.prototype[h]=d[h]};
Lawnchair.prototype={isArray:Array.isArray||function(d){return Object.prototype.toString.call(d)==="[object Array]"},indexOf:function(d,h,a,b){if(d.indexOf)return d.indexOf(h);a=0;for(b=d.length;a<b;a++)if(d[a]===h)return a;return-1},lambda:function(d){return this.fn(this.record,d)},fn:function(d,h){return typeof h=="string"?new Function(d,h):h},uuid:function(){var d=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()},each:function(d){var h=
this.lambda(d);if(this.__results){d=0;for(var a=this.__results.length;d<a;d++)h.call(this,this.__results[d],d)}else this.all(function(b){for(var c=0,e=b.length;c<e;c++)h.call(this,b[c],c)});return this}};
Lawnchair.adapter("window-name",function(){if(typeof window==="undefined")window={top:{}};var d={};try{d=JSON.parse(window.top.name)}catch(h){}return{valid:function(){return typeof window.top.name!="undefined"},init:function(a,b){d[this.name]=d[this.name]||{index:[],store:{}};this.index=d[this.name].index;this.store=d[this.name].store;this.fn(this.name,b).call(this,this);return this},keys:function(a){this.fn("keys",a).call(this,this.index);return this},save:function(a,b){var c=a.key||this.uuid();
this.exists(c,function(e){if(!e){a.key&&delete a.key;this.index.push(c)}this.store[c]=a;try{window.top.name=JSON.stringify(d)}catch(g){if(!e){this.index.pop();delete this.store[c]}throw g;}if(b){a.key=c;this.lambda(b).call(this,a)}});return this},batch:function(a,b){for(var c=[],e=0,g=a.length;e<g;e++)this.save(a[e],function(f){c.push(f)});b&&this.lambda(b).call(this,c);return this},get:function(a,b){var c;if(this.isArray(a)){c=[];for(var e=0,g=a.length;e<g;e++)c.push(this.store[a[e]])}else if(c=
this.store[a])c.key=a;b&&this.lambda(b).call(this,c);return this},exists:function(a,b){this.lambda(b).call(this,!!this.store[a]);return this},all:function(a){for(var b=[],c=0,e=this.index.length;c<e;c++){var g=this.store[this.index[c]];g.key=this.index[c];b.push(g)}this.fn(this.name,a).call(this,b);return this},remove:function(a,b){for(var c=this.isArray(a)?a:[a],e=0,g=c.length;e<g;e++){var f=c[e].key?c[e].key:c[e],i=this.indexOf(this.index,f);if(!(i<0)){delete this.store[f];this.index.splice(i,1)}}window.top.name=
JSON.stringify(d);b&&this.lambda(b).call(this);return this},nuke:function(a){this.store=d[this.name].store={};this.index=d[this.name].index=[];window.top.name=JSON.stringify(d);a&&this.lambda(a).call(this);return this}}}());
Lawnchair.adapter("dom",function(){var d=window.localStorage,h=function(a){return{key:a+"._index_",all:function(){var b=d.getItem(this.key);if(b)b=JSON.parse(b);b===null&&d.setItem(this.key,JSON.stringify([]));return JSON.parse(d.getItem(this.key))},add:function(b){var c=this.all();c.push(b);d.setItem(this.key,JSON.stringify(c))},del:function(b){for(var c=this.all(),e=[],g=0,f=c.length;g<f;g++)c[g]!=b&&e.push(c[g]);d.setItem(this.key,JSON.stringify(e))},find:function(b){for(var c=this.all(),e=0,g=
c.length;e<g;e++)if(b===c[e])return e;return false}}};return{valid:function(){return!!d&&function(){var a=true,b=Math.random();try{d.setItem(b,b)}catch(c){a=false}d.removeItem(b);return a}()},init:function(a,b){this.indexer=h(this.name);b&&this.fn(this.name,b).call(this,this)},save:function(a,b){var c=a.key?this.name+"."+a.key:this.name+"."+this.uuid();delete a.key;d.setItem(c,JSON.stringify(a));this.indexer.find(c)===false&&this.indexer.add(c);a.key=c.slice(this.name.length+1);b&&this.lambda(b).call(this,
a);return this},batch:function(a,b){for(var c=[],e=0,g=a.length;e<g;e++)this.save(a[e],function(f){c.push(f)});b&&this.lambda(b).call(this,c);return this},keys:function(a){if(a){var b=this.name,c=this.indexer.all(),e=[];if(Array.prototype.map)e=c.map(function(f){return f.replace(b+".","")});else for(var g in c)e.push(g.replace(b+".",""));this.fn("keys",a).call(this,e)}return this},get:function(a,b){if(this.isArray(a)){for(var c=[],e=0,g=a.length;e<g;e++){var f=this.name+"."+a[e];if(f=d.getItem(f)){f=
JSON.parse(f);f.key=a[e]}c.push(f)}b&&this.lambda(b).call(this,c)}else{f=this.name+"."+a;if(f=d.getItem(f)){f=JSON.parse(f);f.key=a}b&&this.lambda(b).call(this,f)}return this},exists:function(a,b){var c=this.indexer.find(this.name+"."+a)===false?false:true;this.lambda(b).call(this,c);return this},all:function(a){for(var b=this.indexer.all(),c=[],e,g,f=0,i=b.length;f<i;f++){g=b[f];e=JSON.parse(d.getItem(g));e.key=g.replace(this.name+".","");c.push(e)}a&&this.fn(this.name,a).call(this,c);return this},
remove:function(a,b){var c=this;if(this.isArray(a)){var e,g=a.length,f=function(i){c.remove(a[i],function(){--g>0||b&&c.lambda(b).call(c)})};for(e=0;e<a.length;e++)f(e);return this}e=this.name+"."+(a.key?a.key:a);this.indexer.del(e);d.removeItem(e);b&&this.lambda(b).call(this);return this},nuke:function(a){this.all(function(b){for(var c=0,e=b.length;c<e;c++)this.remove(b[c]);a&&this.lambda(a).call(this)});return this}}}());
